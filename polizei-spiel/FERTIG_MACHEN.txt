# ðŸŽ¯ FINALE 3 FEATURES - FERTIGE IMPLEMENTIERUNG

Da das Fahrzeug-Panel in deinem Code nicht als separates Panel existiert (Fahrzeuge werden nur in Listen gezeigt), hier die **angepasste Implementierung**:

## âœ… WAS ICH FERTIG GEMACHT HABE:

1. âœ… Smart Assignment Button - FUNKTIONIERT
2. âœ… MANV Progress-Bar - EINGEFÃœGT  
3. âœ… CSS fÃ¼r alle Features - HINZUGEFÃœGT

## ðŸ“ WAS NOCH FEHLT (vereinfachte Version):

### Feature 1: Schichtwechsel (ALTERNATIV-LÃ–SUNG)

**Problem**: Kein dediziertes Fahrzeug-Panel gefunden wo Button eingefÃ¼gt werden kann.

**LÃ¶sung**: FÃ¼ge Schichtwechsel als **Hotkey** hinzu!

**In `src/hooks/useHotkeys.ts` ERGÃ„NZEN**:

FÃ¼ge in die Interface `HotkeyHandlers` hinzu:
```typescript
onShiftChange?: () => void;
```

FÃ¼ge in `handleKeyDown` hinzu (nach Zeile 60):
```typescript
// S - Schichtwechsel
if (key === 's' && handlers.onShiftChange) {
  event.preventDefault();
  handlers.onShiftChange();
}
```

**In `src/App.tsx` im useHotkeys-Call ERGÃ„NZEN** (nach Zeile 548):
```typescript
onShiftChange: () => {
  if (selectedVehicleId) {
    const vehicle = vehicles.find(v => v.id === selectedVehicleId);
    if (vehicle && vehicle.status === 'S1' && vehicle.crewFatigue > 60) {
      setVehicles(prev => prev.map(v =>
        v.id === selectedVehicleId ? performShiftChange(v, gameTime) : v
      ));
      setGameTime(t => t + 5);
      addLog(`ðŸ‘¥ Schichtwechsel: Fahrzeug ${selectedVehicleId} - MÃ¼digkeit zurÃ¼ckgesetzt`, 'system');
    }
  }
},
```

**Jetzt**: DrÃ¼cke **S** bei ausgewÃ¤hltem Fahrzeug mit >60% MÃ¼digkeit â†’ Schichtwechsel!

---

### Feature 2 & 3: S7 Tankstellen-Routing

**Suche in App.tsx nach** (ca. Zeile 1327):
```
status: shouldGoS6 ? 'S6' : 'S1',
```

**ERSETZE die gesamte return-Anweisung mit**:
```typescript
// PrÃ¼fe ob tanken nÃ¶tig
const needsRefueling = shouldRefuel(updatedVehicle);
const finalStatus: VehicleStatus = shouldGoS6 ? 'S6' : (needsRefueling ? 'S7' : 'S1');

// Bei S7: Route zur Tankstelle
if (finalStatus === 'S7') {
  const nearestStation = findNearestGasStation(vehicle.position, gasStations);
  if (nearestStation) {
    addLog(`â›½ Fahrzeug ${vehicle.id} fÃ¤hrt zur Tankstelle (${nearestStation.name})`, 'system');
    
    (async () => {
      try {
        const osrmRoute = await getRoute(
          { lat: vehicle.position[0], lng: vehicle.position[1] },
          { lat: nearestStation.position[0], lng: nearestStation.position[1] }
        );
        
        if (osrmRoute) {
          const route = convertToLeafletFormat(osrmRoute.coordinates);
          setVehicles(prev => prev.map(v =>
            v.id === vehicle.id && v.status === 'S7' ? {
              ...v,
              route,
              routeDuration: osrmRoute.duration * 0.7,
              routeStartTime: Date.now(),
              routeProgress: 0,
              accumulatedTime: 0,
            } : v
          ));
        }
      } catch (e) {
        console.error('S7 Route Error:', e);
      }
    })();
  }
}

return {
  ...updatedVehicle,
  position: station ? station.position : vehicle.position,
  assignedIncidentId: null,
  routeIndex: 0,
  route: null,
  routeProgress: 0,
  bearing: 0,
  routeDuration: 0,
  routeStartTime: 0,
  status: finalStatus,
  processingStartTime: null,
  processingDuration: 0,
  outOfServiceReason: shouldGoS6 ? s6Reason : null,
  outOfServiceUntil: shouldGoS6 ? calculateOutOfServiceDuration(s6Reason!, gameTime) : null,
  accumulatedTime: 0,
};
```

**Dann suche nach**: `// S8: RÃ¼ckfahrt zur Wache` (ca. Zeile 1330)

**FÃœGE DAVOR EIN**:
```typescript
// S7: Fahrt zur Tankstelle
if (vehicle.status === 'S7' && vehicle.route) {
  const accumulatedTime = vehicle.accumulatedTime || 0;
  const newAccumulatedTime = accumulatedTime + scaledDeltaTime;
  const newProgress = Math.min(newAccumulatedTime / vehicle.routeDuration, 1);

  if (newProgress >= 1) {
    const tankDuration = calculateRefuelDuration(vehicle.fuelLevel, vehicleTypeConfigs[vehicle.vehicleType].tankCapacity);
    addLog(`â›½ Fahrzeug ${vehicle.id} tankt (${Math.ceil(tankDuration/60)} Min)`, 'system');
    
    return {
      ...vehicle,
      status: 'S6' as VehicleStatus,
      route: null,
      routeProgress: 0,
      outOfServiceReason: 'Tanken',
      outOfServiceUntil: gameTime + (tankDuration / 60),
      fuelLevel: 100,
      accumulatedTime: 0,
    };
  }

  const { position: newPosition, bearing: newBearing } = getPointAlongRoute(vehicle.route, newProgress);
  return {
    ...vehicle,
    position: newPosition,
    routeProgress: newProgress,
    bearing: newBearing,
    accumulatedTime: newAccumulatedTime,
  };
}
```

---

## ðŸŽ¯ ZUSAMMENFASSUNG:

**3 Ã„nderungen nÃ¶tig**:
1. Hotkey 'S' fÃ¼r Schichtwechsel in useHotkeys.ts
2. S7-Status beim S8â†’S1 Ãœbergang
3. S7-Movement-Logic vor S8-Block

**GeschÃ¤tzte Zeit**: 5-7 Minuten

**Danach hast du**:
- âœ… Smart Assignment Button
- âœ… MANV Progress-Bar
- âœ… Schichtwechsel (Hotkey S)
- âœ… Automatisches Tanken bei <15%
- âœ… S7 Status & Routing
- âœ… Alle Hotkeys (1-9, E, H, S, +/-, Leertaste, ESC)
- âœ… Komplett optimiertes Spiel!

**Server**: http://localhost:5173/
